{% extends 'base.html' %}
{% block title %}Timed Mode · {{ APP_NAME or "Ball Knowledge" }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-screen-sm px-3 pt-3 pb-[max(5.25rem,env(safe-area-inset-bottom))]">

  <!-- Prompt card -->
  <section class="mb-6">
    <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-lg p-5 relative">
      <!-- Top row: Position pill (left) + Round Score pill (right) -->
      <div class="flex items-start justify-between gap-3">
        <!-- Position pill -->
        <div class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/60 backdrop-blur-sm px-3 py-2 text-slate-200 text-sm shadow">
          <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
            <path d="M10 2a8 8 0 100 16 8 8 0 000-16Zm1 5a1 1 0 10-2 0v3.586l-1.293 1.293a1 1 0 101.414 1.414l1.586-1.586A2 2 0 0011 10V7Z"/>
          </svg>
          <span class="font-semibold tracking-wide">{{ player_position }}</span>
        </div>

        <!-- ROUND score pill (top-right on desktop, floating bottom-right on mobile if desired elsewhere) -->
        <div
          id="liveScorePill"
          class="sm:sticky sm:top-2 sm:ml-4 shrink-0 inline-flex items-center gap-2 rounded-full border border-emerald-800 bg-emerald-900/60 backdrop-blur-sm px-4 py-2 text-emerald-300 text-base shadow"
          data-start="{{ start_score }}"
          data-penalty="{{ penalty_per_reveal }}"
          data-revealed="{{ revealed }}"
          data-hints='{{ hints_used | tojson }}'
          data-hintcosts='{{ hint_costs | tojson }}'
        >
          <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
            <path d="M10 2a8 8 0 100 16 8 8 0 000-16Zm1 5a1 1 0 10-2 0v3.586l-1.293 1.293a1 1 0 101.414 1.414l1.586-1.586A2 2 0 0011 10V7Z"/>
          </svg>
          <span class="font-medium">Round</span>
          <span id="liveScoreValue" class="font-bold">—</span>
        </div>
      </div>

      {# Player-level hints (first/last/college) with fixed line height to avoid reflow #}
      {% set hv0 = (hints_for_lines[0] if hints_for_lines and hints_for_lines|length > 0 else {}) %}
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <p class="text-slate-400 leading-6 min-h-[1.5rem]">
          First name:
          {% if 'first_name' in hints_used %}
            <span class="font-medium text-slate-200">{{ hv0.first_name or '—' }}</span>
          {% else %}
            <span class="italic text-slate-500">hidden</span>
          {% endif %}
        </p>
        <p class="text-slate-400 leading-6 min-h-[1.5rem]">
          Last name:
          {% if 'last_name' in hints_used %}
            <span class="font-medium text-slate-200">{{ hv0.last_name or '—' }}</span>
          {% else %}
            <span class="italic text-slate-500">hidden</span>
          {% endif %}
        </p>
        <p class="text-slate-400 leading-6 min-h-[1.5rem]">
          College:
          {% if 'college' in hints_used %}
            <span class="font-medium text-slate-200">{{ hv0.college or '—' }}</span>
          {% else %}
            <span class="italic text-slate-500">hidden</span>
          {% endif %}
        </p>
      </div>

      <!-- Revealed stat lines -->
      <div class="mt-4 grid gap-3">
        {% for line in stat_lines %}
          {% set hv = (hints_for_lines[loop.index0] if hints_for_lines and loop.index0 < hints_for_lines|length else {}) %}
          <div class="rounded-lg border border-slate-700 bg-slate-900/50 px-4 py-3">
            <div class="font-semibold text-slate-200 flex items-center justify-between">
              <span>Season {{ line.season }}</span>
            </div>

            <div class="text-sm text-slate-300 mt-1">
              {% for k, v in line.stats.items() %}
                <span class="inline-block mr-3">
                  <span class="text-slate-400">{{ k }}:</span>
                  <span class="font-medium">{{ v }}</span>
                </span>
              {% endfor %}
            </div>

            <!-- Inline hints for THIS season -->
            <div class="mt-2 text-xs text-slate-400 flex flex-wrap gap-x-4 gap-y-1">
              <span>
                <span class="text-slate-500">Team:</span>
                {% if 'team' in hints_used %}
                  <span class="font-medium">{{ hv.team or '—' }}</span>
                {% else %}
                  <span class="italic">hidden</span>
                {% endif %}
              </span>
              <span>
                <span class="text-slate-500">Conference:</span>
                {% if 'conference' in hints_used or 'division' in hints_used or 'team' in hints_used %}
                  <span class="font-medium">{{ hv.conference or '—' }}</span>
                {% else %}
                  <span class="italic">hidden</span>
                {% endif %}
              </span>
              <span>
                <span class="text-slate-500">Division:</span>
                {% if 'division' in hints_used or 'team' in hints_used %}
                  {% if hv.conference and hv.division %}
                    <span class="font-medium">{{ hv.conference | upper }} {{ hv.division }}</span>
                  {% elif hv.division %}
                    <span class="font-medium">{{ hv.division }}</span>
                  {% else %}
                    <span class="font-medium">—</span>
                  {% endif %}
                {% else %}
                  <span class="italic">hidden</span>
                {% endif %}
              </span>
              <span>
                <span class="text-slate-500">Record:</span>
                {% if 'record' in hints_used %}
                  <span class="font-medium">{{ hv.record or '—' }}</span>
                {% else %}
                  <span class="italic">hidden</span>
                {% endif %}
              </span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Hints + Guess -->
  <section class="grid md:grid-cols-2 gap-6">

    <!-- Hints -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-lg p-5">
      <h3 class="font-semibold text-slate-100">Hints</h3>
      <p class="text-xs text-slate-400 mb-2">Hints apply to every revealed season line. Using hints lowers the points you’ll get on this round.</p>

      {% if available_hints and available_hints|length > 0 %}
        <form method="post" action="{{ hint_action }}" class="grid grid-cols-2 gap-2 sm:flex sm:flex-wrap sm:gap-2">
          <input type="hidden" name="revealed" value="{{ revealed }}" />
          {% for h in available_hints %}
            {% if not ('division' in hints_used and h == 'conference') %}
              <button
                name="hint_type"
                value="{{ h }}"
                type="submit"
                class="w-full sm:w-auto inline-flex items-center justify-center rounded-lg bg-slate-700 border border-slate-600 px-3 py-2.5 text-sm font-medium text-slate-200 shadow-sm hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                {% if h == 'division' %}
                  Division (incl. Conf)
                {% elif h == 'team' %}
                  Team (incl. Conf/Div)
                {% elif h == 'first_name' %}
                  First Name
                {% elif h == 'last_name' %}
                  Last Name
                {% else %}
                  {{ h|capitalize }}
                {% endif %}
                <span class="ml-1 text-slate-400">(-{{ hint_costs[h] }})</span>
              </button>
            {% endif %}
          {% endfor %}
        </form>
      {% else %}
        <p class="text-sm text-slate-400">No more hints available.</p>
      {% endif %}
    </div>

    <!-- Guess -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-lg p-5">
      <h3 class="font-semibold text-slate-100 mb-3">Your Guess</h3>

      <form method="post" action="{{ url_for('main.timed_guess') }}" class="grid gap-3">
        <input type="hidden" name="revealed" value="{{ revealed }}" />

        <input
          type="text"
          name="guess"
          required
          placeholder="Type the player's name..."
          autocapitalize="words"
          autocomplete="off"
          autocorrect="off"
          enterkeyhint="go"
          inputmode="text"
          class="w-full rounded-lg border border-slate-600 bg-slate-700 px-3 py-3 text-base text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
        />

        <div class="flex flex-wrap gap-2">
          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-3 font-medium text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-indigo-500"
          >
            Submit Guess
          </button>

          <button
            type="submit"
            formaction="{{ url_for('main.timed_skip') }}"
            formmethod="post"
            formnovalidate
            class="inline-flex items-center justify-center rounded-lg bg-rose-600 px-4 py-3 font-medium text-white shadow-sm hover:bg-rose-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-rose-500"
          >
            Skip (-50)
          </button>
        </div>

        <p class="text-xs text-slate-400">Wrong guesses reveal another season line and reduce this round’s points. Skipping immediately loses 50 points and moves to the next player.</p>
      </form>

      {% if suggestions and suggestions|length > 0 %}
        <div class="mt-3">
          <p class="text-sm text-slate-300 mb-2">
            Did you mean:
            <span class="text-slate-400">(choosing a suggestion will count as your next guess)</span>
          </p>
          <div class="flex flex-wrap gap-2">
            {% for s in suggestions %}
              <form method="post" action="{{ url_for('main.timed_guess') }}">
                <input type="hidden" name="revealed" value="{{ revealed }}">
                <input type="hidden" name="guess" value="{{ s }}">
                <input type="hidden" name="from_suggestion" value="1">
                <button
                  type="submit"
                  class="w-full sm:w-auto inline-flex items-center justify-center rounded-full bg-slate-700 border border-slate-600 px-3 py-2.5 text-sm font-medium text-slate-200 shadow-sm hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  title="Try {{ s }}"
                >
                  {{ s }}
                </button>
              </form>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

  </section>
</div>

{# ======= FLOATING PILLS (Timer left, Total right) ======= #}
<div
  id="timerPill"
  class="fixed left-3 z-50 inline-flex items-center gap-2 rounded-full border border-indigo-800 bg-indigo-900/60 backdrop-blur-sm px-4 py-2 text-indigo-300 text-base shadow-lg
         sm:static sm:ml-3 sm:mt-2 sm:sticky sm:top-2 sm:left-auto"
  style="bottom: calc(0.75rem + env(safe-area-inset-bottom));"
  data-seconds="{{ seconds|default(120) }}"
>
  <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
    <path d="M10 2a8 8 0 100 16 8 8 0 000-16Zm1 5a1 1 0 10-2 0v3.586l-1.293 1.293a1 1 0 101.414 1.414l1.586-1.586A2 2 0 0011 10V7Z"/>
  </svg>
  <span class="font-medium">Time</span>
  <span id="timerValue" class="font-bold">2:00</span>
</div>

<div
  id="totalScorePill"
  class="fixed right-3 z-50 inline-flex items-center gap-2 rounded-full border border-emerald-800 bg-emerald-900/60 backdrop-blur-sm px-4 py-2 text-emerald-300 text-base shadow-lg
         sm:static sm:ml-3 sm:mt-2 sm:sticky sm:top-2 sm:float-right"
  style="bottom: calc(0.75rem + env(safe-area-inset-bottom));"
>
  <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
    <path d="M4 10a6 6 0 1112 0 6 6 0 01-12 0Zm3-1h6a1 1 0 010 2H7a1 1 0 010-2Z"/>
  </svg>
  <span class="font-medium">Total</span>
  <span class="font-bold">{{ total_score }}</span>
</div>

<!-- Hidden finish form (auto-submitted on timer end) -->
<form id="timedFinishForm" method="post" action="{{ url_for('main.timed_finish') }}"></form>
{% endblock %}

{% block scripts %}
<script>
  // --- Round score (from dataset) ---
  (function () {
    function calcScore(start, perReveal, revealed, hints, hintCosts) {
      const r = Math.max(1, Number(revealed) || 1);
      let base = Number(start) - Number(perReveal) * (r - 1);
      const seen = new Set();
      let hp = 0;
      (hints || []).forEach(h => {
        const key = (String(h || '')).toLowerCase().trim();
        if (!key || seen.has(key)) return;
        seen.add(key);
        hp += Number(hintCosts[key] || 0);
      });
      return Math.max(0, Math.floor(base - hp));
    }

    const pill = document.getElementById('liveScorePill');
    const out  = document.getElementById('liveScoreValue');
    if (!pill || !out) return;

    let hints = [];
    let costs = {};
    try { hints = JSON.parse(pill.dataset.hints || '[]'); } catch {}
    try { costs = JSON.parse(pill.dataset.hintcosts || '{}'); } catch {}

    const start    = Number(pill.dataset.start || 100);
    const perRev   = Number(pill.dataset.penalty || 20);
    const revealed = Number(pill.dataset.revealed || 1);
    out.textContent = calcScore(start, perRev, revealed, hints, costs);
  })();

  // --- Timer (mm:ss, auto-finish at 0) ---
  (function () {
    const pill = document.getElementById('timerPill');
    const out  = document.getElementById('timerValue');
    const form = document.getElementById('timedFinishForm');
    if (!pill || !out || !form) return;

    let secs = Number(pill.dataset.seconds || 120);
    function fmt(s) {
      const m = Math.floor(s / 60);
      const r = s % 60;
      return m + ':' + (r < 10 ? '0' + r : r);
    }
    function tick() {
      if (secs <= 0) {
        out.textContent = '0:00';
        try { form.submit(); } catch (_) {}
        return;
      }
      out.textContent = fmt(secs);
      secs -= 1;
      setTimeout(tick, 1000);
    }
    out.textContent = fmt(secs);
    tick();
  })();
</script>
{% endblock %}
